# design - 設計依頼書をもとに、設計書を生成します

## 概要
設計依頼書の内容をもとに、設計の焦点に応じた詳細な設計ドキュメントを生成します。

## 使用方法
```
/design [設計依頼書パス]
```

### 例
```
/design                                                              # デフォルトパスを使用
/design ~/workspace/tasks/TASK-12345/design-request.md              # 特定のパスを指定
/design ./docs/design-request.md                                    # 相対パスで指定
```

## 実行内容
1. 設計依頼書ファイルの内容を読み込み（パス指定がない場合は `~/workspace/tasks/design.md` を使用）
2. 設計の焦点（チェックされた項目）の確認
3. 焦点に応じた設計ドキュメントの作成
4. 必要に応じてMermaid図の生成
5. `~/workspace/tasks/{チケット番号}/design` 配下に保存

## 出力ファイル
| ファイルタイプ | パス | 説明 |
|--------------|------|------|
| 設計書 | `~/workspace/tasks/{チケット番号}/design/{機能名}-design.md` | 詳細設計ドキュメント |
| 技術調査 | `~/workspace/tasks/{チケット番号}/design/technical-research.md` | SDK/API調査結果（必要時） |

## プロンプト

指定された設計依頼書（デフォルト: ~/workspace/tasks/design.md）の内容を読み込み、以下の手順で設計ドキュメントを作成してください：

1. **設計依頼書ファイルの読み込み**
   - コマンド引数でパスが指定された場合はそのファイルを使用
   - 指定がない場合は `~/workspace/tasks/design.md` を使用
   - ファイルが存在することを確認
   - 内容を読み込んで分析
   - チケット番号、機能名、要件を抽出
   - 「設計の焦点」でチェックされた項目を確認

2. **技術調査の実施**
   - 使用するSDK/ライブラリの機能確認
   - 既存実装パターンの調査
   - API制約事項の確認
   - 既知の問題点の洗い出し

3. **設計要件の分析**
   - 機能要件の整理
   - 非機能要件の整理
   - 制約事項の明確化
   - 既存システムとの関連性の分析
   - 影響を受ける機能の確認
   - 参考実装の調査

4. **設計の焦点に応じた設計作成**
   設計の焦点でチェックされた項目に応じて、該当する設計を重点的に作成：
   
   **設計原則**：
   - 「What」と「Why」に焦点を当て、「How」は最小限に
   - 既存システムとの統合点を明確に定義
   - 実装の詳細（内部アルゴリズムなど）は記載しない
   - インターフェースと責務の定義に注力
   
   **焦点別の設計内容**：
   - **アーキテクチャ設計**: コンポーネント構成、レイヤー構造、責務の明確化
   - **クラス設計**: 責務の分離、クラス間の関係、インターフェース定義
   - **シーケンス設計**: 処理フロー、相互作用、エラーケースの流れ
   - **データ設計**: テーブル構造、エンティティ定義、制約事項
   - **インターフェース設計**: API仕様、入出力定義、エラーレスポンス
   - **エラーハンドリング設計**: 例外処理、エラー伝播、リカバリー戦略
   - **その他**: 指定された観点での設計

5. **図の作成（必要に応じて）**
   設計の焦点に応じて適切な図を作成：
   
   ### アーキテクチャ設計の場合
   ```mermaid
   graph TB
     subgraph "アプリケーション層"
       Service[ビジネスロジック]
     end
     subgraph "データ層"
       DB[(データベース)]
     end
   ```
   
   ### クラス設計の場合
   ```mermaid
   classDiagram
     class ClassName {
       -privateField: Type
       +publicMethod(): ReturnType
     }
   ```
   
   ### シーケンス設計の場合
   ```mermaid
   sequenceDiagram
     participant Actor
     participant System
     participant Database
     
     Actor->>System: リクエスト
     System->>Database: データ取得
     Database-->>System: データ返却
     System-->>Actor: レスポンス
   ```

6. **詳細設計の記述**
   設計の焦点に応じた詳細な設計内容を記述：
   - 問題の分析と原因の特定
   - 解決策の提案
   - 実装方針の明確化
   - 段階的な実装計画の策定
   - 既存システムへの影響評価

7. **ドキュメント構成**
   設計の焦点に応じて適切な構成を採用：
   
   ```markdown
   # [機能名] 設計書
   
   ## 1. 概要
   ### 1.1 背景と目的
   [設計依頼書の機能概要と要件から抽出]
   
   ### 1.2 スコープ
   - **含む**: [この設計で対応する範囲]
   - **含まない**: [この設計の対象外]
   
   ### 1.3 成功基準
   [この設計が成功したと判断できる基準]
   
   ## 2. 要件分析
   ### 2.1 機能要件
   [必須機能の整理]
   
   ### 2.2 非機能要件
   [パフォーマンス、信頼性、セキュリティ等]
   
   ### 2.3 制約事項
   [技術的制約、既存システムとの制約]
   
   ## 3. 技術調査結果
   ### 3.1 SDK/API調査
   [使用するライブラリの機能と制限]
   
   ### 3.2 既存実装パターン
   [参考にすべき既存の実装]
   
   ### 3.3 既知の問題と対策
   [事前に判明している問題点]
   
   ## 4. 設計
   [設計の焦点に応じたセクション]
   
   ## 5. 実装計画
   ### 5.1 実装順序
   [優先順位と依存関係]
   
   ### 5.2 テスト戦略
   [テストの方針と重点項目]
   
   ### 5.3 リスクと対策
   [想定されるリスクと緩和策]
   ```

8. **設計検証**
   以下の観点で設計の妥当性を検証：
   
   **実装可能性の検証**：
   - 必須パラメータの取得方法は明確か
   - エラーケースは網羅されているか  
   - パフォーマンス要件は達成可能か
   - テスト可能な設計になっているか
   
   **既存システムとの整合性**：
   - 既存のアーキテクチャと矛盾しないか
   - 既存のコーディング規約に準拠しているか
   - 他のコンポーネントへの影響は考慮されているか

9. **参考実装の調査**
   設計依頼書に記載された参考実装ファイルを実際に読み込んで分析：
   - 現在の実装方法の理解
   - 問題箇所の特定
   - 改善可能な箇所の発見

10. **品質確認**
   - 設計依頼書の要件がすべてカバーされているか
   - 設計に矛盾がないか
   - 実装可能性が検証されているか
   - 技術調査の結果が反映されているか
   - 既存システムとの整合性が保たれているか

11. **最終出力**
   - チケット番号の取得: ブランチ名やファイルパスから抽出
   - ファイル名: `{機能名}-design.md`
   - 保存先: `~/workspace/tasks/{チケット番号}/design/`
   - ファイル保存時の処理:
     - 保存先ディレクトリが存在しない場合は作成
     - 同名ファイルが存在する場合はバックアップを作成
     - 保存完了後にファイルパスを表示

12. **完了**

### 進捗表示
```
========================================
🚀 実行中: design - ステップ {current}/{total}
========================================
📍 ステップ {N}: {ステップ名}
⏱️  開始時刻: {timestamp}

[処理内容]

✅ ステップ {N} 完了
   実行時間: {duration}秒
   出力: {file-path}
----------------------------------------
```

## 特記事項
- 既存のアーキテクチャとの整合性を重視
- プロジェクトの設計規約に準拠
- **重要**: ドキュメント内に作成日時や日付を記載しない
- **重要**: ファイル名に日付を含めない
- **重要**: 設計は「What」と「Why」に焦点を当て、実装詳細（How）は最小限に

## 設計品質チェックリスト
設計完了時に以下の項目を確認：
- [ ] 要件との整合性が取れているか
- [ ] 技術的実現可能性が検証されたか
- [ ] 既存システムへの影響が明確か
- [ ] テスト可能な設計になっているか
- [ ] パフォーマンス要件を満たせるか
- [ ] セキュリティ考慮事項が含まれているか
- [ ] エラーケースが網羅されているか
- [ ] 将来の拡張性が考慮されているか

## エラーハンドリング
- 設計依頼書ファイルが見つからない場合：エラーメッセージを表示して終了
- 必須項目（チケット番号、機能名など）が不足している場合：具体的な不足項目を提示
- 設計の焦点が指定されていない場合：デフォルトで主要な設計を網羅的に作成