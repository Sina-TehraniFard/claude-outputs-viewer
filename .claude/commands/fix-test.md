# fix-test - テストコードをガイドラインに準拠するよう修正します

## 概要
指定されたテストコードをプロジェクトのテストガイドラインに準拠するよう自動修正します。
段階的改善パターンを使用して、安全かつ確実にテスト品質を向上させます。

## 使用方法
```
/fix-test [タグ] <TestCode or TestFilePath>
```

### 例
```bash
# 基本使用方法
/fix-test UserServiceTest.kt

# タグ付き実行
/fix-test @test-fix AzureAdConnectorGatewayTest.kt
/fix-test @api @tdd AzureClientTest.kt
/fix-test @refactor GroupMapperTest.kt
```

### 利用可能なタグ
- `@test-fix`: 段階的テスト改善パターン（1関数ずつ修正）
- `@api`: API関連テスト特有の修正パターン
- `@tdd`: TDDサイクルに適合するテスト構造への修正
- `@refactor`: 既存機能保持でのリファクタリング修正

## 実行内容
1. テストガイドラインの読み込み
2. **自動ナレッジ収集**: 修正パターンの自動記録
2. 現在のテストコードの分析
3. タグに応じた修正戦略の選択
4. 段階的な修正実行
5. コンパイル・実行検証
6. 修正結果のレポート

## プロンプト
指定されたテストコードをプロジェクトテストガイドラインに準拠するよう修正してください。

### 自動ナレッジ管理の初期化
```bash
# プロジェクトの自動ナレッジ機能を読み込み
if [[ -f ".claude/scripts/auto-knowledge.sh" ]]; then
    source .claude/scripts/auto-knowledge.sh
    echo "🧠 自動ナレッジ管理システム有効"
fi
```

### タグ処理とワークフロー選択
1. **引数からタグを抽出し、適切な修正パターンを選択**
   - `@test-fix`: 段階的改善パターン（高成功率実績方式）
   - `@api`: API関連テストの修正パターン
   - `@tdd`: Red-Green-Refactorサイクルに適合するテスト構造修正
   - `@refactor`: 既存テスト破綻回避の安全修正
   - 複数タグ指定時は組み合わせパターンを適用
   - タグ未指定時は内容から自動判定

2. **修正戦略の品質指標設定**
   - `@test-fix`: ガイドライン準拠改善率+5%以上、テスト実行時間±10%以内
   - `@api`: APIテストの統合性保持100%
   - `@tdd`: TDDサイクル準拠率95%以上
   - `@refactor`: 既存テスト成功率100%維持

### 修正手順

1. **テストガイドラインの読み込み**
   - guidelines/testing.mdを読み込み、最新の要件を把握
   - タグ固有の要件を確認

2. **現在のテストコードの分析**
   - テストファイルまたはコードの読み込み
   - ガイドライン違反箇所の特定
   - 修正の優先順位付け

3. **段階的修正の実行**
   **@test-fix タグ使用時（推奨パターン）:**
   - 1つの関数（@Nestedクラス）ずつ修正
   - 各修正後に即座にコンパイル・テスト実行
   - PASSしたら次の関数へ進む
   - 複数関数をまとめて修正することは厳禁
   
   **@api タグ使用時:**
   - API関連テストの一貫性確保
   - 統合テストとの整合性チェック
   - 外部API依存部分のモック適正化
   
   **@tdd タグ使用時:**
   - Red-Green-Refactorサイクルに適合する構造修正
   - テストケースの粒度適正化
   - アサーション内容の改善

4. **修正内容の検証**
   - 全テストのコンパイル成功確認
   - テスト実行結果の確認
   - ガイドライン準拠度の再チェック

5. **修正レポートの出力とファイル保存**
   - 修正した内容の詳細
   - 修正前後のガイドライン準拠率
   - 残存する課題（あれば）
   - 今後の推奨改善点
   - レポートファイルの保存:
     - チケット番号: ブランチ名やファイルパスから抽出
     - 保存先: `~/workspace/tasks/{チケット番号}/fix-test/`
     - ファイル名: `{テストクラス名}-fix-report.md`

6. **自動ナレッジ蓄積**
   - 修正パターンの汎用性を自動判定
   - 成功率90%以上のパターンをナレッジとして保存
   - プロジェクト固有 vs グローバルの自動分類
   - 保存先の自動決定:
     - グローバル: `~/workspace/cc-knowledge/docs/knowledge/`
     - プロジェクト固有: `.claude/knowledge/patterns/`

7. **コード整形の実行**
   - 修正したファイルに応じて適切なコードフォーマッタを実行
   - 実行結果を簡潔に報告
   - エラーがある場合は警告を表示

## 修正ルール

### 段階的改善（@test-fix タグ）
- **1関数ずつの修正**: 複数関数の同時修正禁止
- **即座の検証**: 各修正後のコンパイル・実行必須
- **失敗時の巻き戻し**: 問題発生時は前の成功状態に戻す

### テスト品質
- **命名規則**: shouldで始まるメソッド名
- **@DisplayName**: 明確な説明
- **テスト構造**: Given-When-Then または AAA (Arrange-Act-Assert)
- **モック活用**: 外部依存の適切な分離

### API関連テスト特有ルール (@api タグ)
- **統合テスト連携**: E2Eテストとの整合性
- **外部API制約**: 実際のAPI制限との整合性

### セキュリティ要件
- **秘密情報**: テストコード内への秘密情報記載禁止
- **モックデータ**: 実データに類似しない安全なテストデータ使用

## 自動ナレッジ蓄積のロジック

修正完了後、以下の処理が自動実行されます：

```bash
# 修正パターンの分析と保存
analyze_and_store_pattern() {
    local test_file="$1"
    local modification_pattern="$2"
    local success_rate="$3"
    
    # パターンの汎用性を判定
    local scope=$(analyze_knowledge_scope "$modification_pattern" "$test_file")
    
    # 成功率が90%以上の場合のみ保存
    if [[ "$success_rate" -ge 90 ]]; then
        local title="Test Fix Pattern: $(basename "$test_file" .kt)"
        local tags="\"test-fix\", \"refactoring\", \"automated\""
        
        store_knowledge "$title" "$modification_pattern" "$tags" "${success_rate}%"
        
        # 統計更新
        update_knowledge_indices
        echo "💾 修正パターンをナレッジに保存しました"
    fi
}
```

### 自動分類の基準
- **グローバル保存**: テスト構造、命名規則、一般的なリファクタリングパターン
- **プロジェクト保存**: 特定フレームワークの詳細、ビジネスロジック固有のテスト

## 特記事項
- 修正は安全性を最優先とし、既存のテスト成功率を下げない
- 大規模な修正の場合は段階的なアプローチを必ず採用
- ガイドライン違反が多数ある場合は優先順位を明示
- 修正困難な箇所は理由と代替案を提示
- **ナレッジ蓄積は自動実行**、ユーザーの操作は不要
- **段階的改善で高成功率を達成した実績パターンを活用**

## コード整形の自動実行
- ファイルタイプに応じて適切なフォーマッタを自動実行
- 実行結果を簡潔に報告
- エラーがある場合は警告を表示

## エラーハンドリング
- テストファイルが見つからない場合：エラーメッセージを表示して終了
- コンパイルエラー発生時：エラー内容を詳細に報告し、修正案を提示
- テスト実行失敗時：失敗理由を分析し、段階的修正方針を提案