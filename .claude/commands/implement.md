# implement - 設計書をもとに実装を進めます

## 概要
設計ドキュメントや仕様書から実装を自動的に行うコマンドです。TDDの原則に従い、テストファーストで実装を進めます。

テスト作成とTDDの詳細なガイドラインについては、[テストガイドライン](../docs/guidelines/testing.md)を参照してください。

## 使用方法
```
/implement [タグ] <設計ファイルパス>
```

### 例
```bash
# 基本使用方法
/implement ~/workspace/tasks/TASK-15711/group-deletion-account-dependency-design.md

# タグ付き実行
/implement @tdd ./docs/design/new-feature-design.md
/implement @api ~/workspace/azure-connector-design.md
/implement @security @tdd ~/workspace/saml-integration-design.md
```

### 利用可能なタグ
- `@tdd`: TDDサイクル強制実行（Red-Green-Refactor）
- `@api`: API設計・変更ワークフロー適用
- `@test-fix`: 既存テスト改善パターン適用
- `@refactor`: 安全なリファクタリングワークフロー
- `@security`: セキュリティ要件考慮ワークフロー

## 実行内容
1. 設計ドキュメントの読み込みと分析
2. 実装対象の特定（ファイル、クラス、メソッド）
3. TDDサイクルでの実装
4. 実装結果の報告

## 出力ファイル
| ファイルタイプ | パス | 説明 |
|--------------|------|------|
| 実装レポート | `~/workspace/tasks/{チケット番号}/reports/implementation-{設計名}-report.md` | 実装内容の詳細レポート |
| テストファイル | プロジェクト内のテストディレクトリ | 作成したテストコード |
| 実装ファイル | プロジェクト内のソースディレクトリ | 実装したプロダクションコード |
| TDD記録 | `~/workspace/tasks/{チケット番号}/implementations/tdd-cycle-{機能名}.md` | TDDサイクルの詳細記録 |

## プロンプト
指定された設計ドキュメントを読み込み、以下の手順でTDDに基づいた実装を行ってください。

### タグ処理とワークフロー選択
1. **基本タグ - 汎用的な開発ワークフロー**
   - `@tdd`: Red-Green-Refactorサイクルを厳格に適用
   - `@test-fix`: 既存テスト改善パターン（段階的改善）
   - `@refactor`: 既存テスト破綻回避の安全リファクタリング
   - `@api`: 影響範囲分析と後方互換性検証を含むAPI変更
   - `@security`: セキュリティレビュー要件を満たす実装

2. **自動選択機能**
   - `auto`: ファイルパス・キーワード・設計ファイル分析による最適タグ自動選択
   - 複数タグ指定時は組み合わせワークフローを適用
   - タグ未指定時は内容から自動判定

3. **ワークフロー固有の品質指標設定**
   - `@tdd`: 新規テスト作成率100%、TDDサイクル完遂率95%
   - `@test-fix`: ガイドライン準拠改善率+5%、実行時間±10%以内
   - `@api`: 後方互換性保持率100%、ドキュメント更新完了率100%

### 実装プロセス

1. **設計ドキュメントの分析**
   - ファイルの存在確認と読み込み
   - 実装すべき内容の特定
   - 既存コードとの関連性の確認
   - 技術調査結果の確認（SDK仕様、API制約など）

2. **実装前の確認**
   - 関連する既存コードの調査
   - SDK/ライブラリの使用例確認
   - 設計の曖昧な点の明確化
   - 必要なパラメータの取得方法確認

3. **実装計画の作成**
   - TodoWriteツールを使用して実装タスクをリスト化
   - 各タスクの優先順位と依存関係を明確化
   - TDDサイクルで実装する単位を決定

4. **TDDサイクルでの実装**
   各機能単位で以下のサイクルを繰り返す：
   
   **Red Phase（テスト作成）**
   - まず失敗するテストを作成
   - テストは最小限の機能に焦点を当てる
   - コンパイルと実行を行い、失敗を確認
   
   **Green Phase（実装）**
   - テストを通すための最小限の実装
   - ハードコーディングも許容（後でリファクタリング）
   - テストが通ることを確認
   
   **Refactor Phase（改善）**
   - コードの重複を除去
   - 設計の改善
   - テストが通り続けることを確認
   
   **実装時の発見事項の記録**
   - 設計との差異があった場合は記録
   - API制約による実装変更は明文化
   - パフォーマンス問題は即座に報告
   
   ※ TDDサイクルの詳細は[テストガイドライン - TDD](../docs/guidelines/testing.md#1-tdd-test-driven-development)を参照

5. **実装の検証**
   - すべてのテストが通ることを確認
   - 既存のテストへの影響確認
   - パフォーマンス要件の確認

6. **実装完了のサマリー**
   - 実装したファイルとメソッドの一覧
   - テスト結果のサマリー
   - 設計との差異（あれば）
   - 今後の推奨事項（あれば）

7. **実装レポートの作成と保存**
   - 実装レポートを自動的に作成
   - チケット番号の取得: ブランチ名やファイルパスから抽出
   - ファイル名: `implementation-report.md`（タイムスタンプを含めない）
   - 保存先: `~/workspace/tasks/{チケット番号}/implementation/`
   - 以下の構成でマークダウンファイルを生成:
     1. **概要**
        - 実装した機能の概要
        - 設計ドキュメントへの参照
        - 実装範囲
     2. **実装内容**
        - 追加・修正したファイル一覧
        - 各ファイルの変更内容
        - 新規作成したクラス・メソッド
     3. **TDDサイクルの記録**
        - Red Phase: 作成したテスト
        - Green Phase: 実装した機能
        - Refactor Phase: リファクタリング内容
     4. **技術的詳細**
        - 使用したSDK/API
        - 技術的な課題と解決方法
        - パフォーマンス上の考慮事項
     5. **設計との差異**
        - 設計から変更した点
        - 変更理由と影響
     6. **テスト結果**
        - 実行したテストのサマリー
        - カバレッジ
        - パフォーマンステスト結果（実施した場合）
     7. **制限事項と今後の課題**
        - 既知の制限事項
        - 今後の改善提案
        - 拡張ポイント

8. **コード整形の実行**
   - 作成・修正したファイルに応じて適切なフォーマッタを実行
   - エラーがある場合は警告を表示

9. **完了**
実装レポートの作成とコード整形が完了しました。

### 進捗表示
```
========================================
🚀 実行中: implement - ステップ {current}/{total}
========================================
📍 ステップ {N}: {ステップ名}
⏱️  開始時刻: {timestamp}

[処理内容]

✅ ステップ {N} 完了
   実行時間: {duration}秒
   出力: {file-path}
----------------------------------------
```

## 実装ルール

### TDDの厳守
- **必ずテストを先に書く**：実装コードの前にテストを作成
- **小さなステップ**：一度に大きな機能を実装しない
- **頻繁な実行**：各ステップでコンパイルとテストを実行
- **テスト構造の遵守**：[テストガイドライン](../docs/guidelines/testing.md)に従った構造化

### コード品質
- **既存のコーディング規約に従う**：プロジェクトのスタイルを維持
- **ドキュメントの追加**：publicメソッドには適切なドキュメントを記載
- **エラーハンドリング**：設計書に記載された例外処理を適切に実装
- **テストの命名規則**：[テストガイドライン](../docs/guidelines/testing.md)を参照
- **SDKのデフォルト機能の活用**：二重実装を避ける

### 進捗管理
- **TodoWriteの活用**：各実装ステップをタスクとして管理
- **ステータス更新**：in_progress → completed を適切に更新
- **問題の記録**：実装中の課題や制限事項を記録

### 実装の優先順位
1. コアとなるビジネスロジック
2. エラーハンドリング
3. エッジケースの処理
4. パフォーマンス最適化

## 特記事項
- 設計ドキュメントが不明確な場合は、実装前に確認を求める
- 既存のテストを壊さないよう注意する
- 大規模な変更の場合は、段階的な実装を検討する
- セキュリティに関わる実装は特に慎重に行う
- **実装完了時は必ず実装レポートを出力する（省略不可）**
- **実装レポートのファイル名に日付・タイムスタンプを含めない（常に`implementation-report.md`）**
- **実装レポートの保存先**: `~/workspace/tasks/{チケット番号}/implementation/`
- **テスト作成時は[テストガイドライン](../docs/guidelines/testing.md)を必ず参照**
- **SDKの機能を確認し、車輪の再発明を避ける**
- **設計と実装の差異は必ず記録し、理由を明確にする**

## エラーハンドリング
- ファイルが見つからない場合：エラーメッセージを表示して終了
- 設計内容が不明確な場合：具体的な質問を提示
- テストが失敗し続ける場合：問題の詳細を報告し、アドバイスを求める
- 既存コードとの競合：競合内容を明示し、解決策を提案